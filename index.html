<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CampusConnect</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        /* Custom styles to complement Tailwind */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
        }
        .hidden {
            display: none;
        }
        /* Custom scrollbar for chat and feed */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        /* Simple animation for modals */
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .modal-content {
            animation: fadeIn 0.3s ease-out;
        }
        .whitespace-pre-wrap {
            white-space: pre-wrap;
        }
    </style>
</head>
<body class="antialiased">

    <!-- Main Application Container -->
    <div id="app-container">

        <!-- Loading Screen -->
        <div id="loading-screen" class="fixed inset-0 bg-white flex flex-col justify-center items-center z-50">
            <div class="text-3xl font-bold text-indigo-600">CampusConnect</div>
            <div class="mt-4">
                <i class="fas fa-spinner fa-spin text-4xl text-indigo-500"></i>
            </div>
            <p class="mt-2 text-gray-600">Loading...</p>
        </div>

        <!-- Login Screen -->
        <div id="login-screen" class="hidden min-h-screen flex items-center justify-center bg-gray-100">
            <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-xl shadow-lg">
                <h1 class="text-3xl font-bold text-center text-indigo-600">Welcome to CampusConnect</h1>
                <p class="text-center text-gray-500">Connect with your campus community.</p>
                <form id="login-form" class="space-y-6">
                    <div>
                        <label for="login-email" class="text-sm font-medium text-gray-700">Email address</label>
                        <input id="login-email" type="email" required class="w-full px-4 py-2 mt-1 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="login-password" class="text-sm font-medium text-gray-700">Password</label>
                        <input id="login-password" type="password" required class="w-full px-4 py-2 mt-1 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <button id="login-button" type="submit" class="w-full flex justify-center items-center py-3 px-4 text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 font-semibold disabled:bg-indigo-400">
                        <span class="btn-text">Log In</span>
                        <i class="fas fa-spinner fa-spin btn-loader hidden ml-2"></i>
                    </button>
                </form>
                <div id="login-error" class="text-red-500 text-sm text-center"></div>
                <p class="text-sm text-center text-gray-600">
                    Don't have an account? <a href="#" id="show-signup" class="font-medium text-indigo-600 hover:underline">Sign up</a>
                </p>
            </div>
        </div>

        <!-- Signup Screen -->
        <div id="signup-screen" class="hidden min-h-screen flex items-center justify-center bg-gray-100 py-12">
            <div class="w-full max-w-lg p-8 space-y-6 bg-white rounded-xl shadow-lg">
                <h1 class="text-3xl font-bold text-center text-indigo-600">Create Your Account</h1>
                <form id="signup-form" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="text-sm font-medium text-gray-700">Full Name</label>
                            <input id="signup-name" type="text" required class="w-full px-4 py-2 mt-1 border rounded-lg">
                        </div>
                        <div>
                            <label class="text-sm font-medium text-gray-700">College Roll Number / ID</label>
                            <input id="signup-roll" type="text" required class="w-full px-4 py-2 mt-1 border rounded-lg">
                        </div>
                        <div>
                            <label class="text-sm font-medium text-gray-700">Department</label>
                            <input id="signup-department" type="text" required class="w-full px-4 py-2 mt-1 border rounded-lg">
                        </div>
                        <div>
                            <label class="text-sm font-medium text-gray-700">Class / Year</label>
                            <input id="signup-class" type="text" required class="w-full px-4 py-2 mt-1 border rounded-lg">
                        </div>
                         <div>
                            <label class="text-sm font-medium text-gray-700">Gender</label>
                            <select id="signup-gender" required class="w-full px-4 py-2 mt-1 border rounded-lg bg-white">
                                <option value="">Select Gender</option>
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-sm font-medium text-gray-700">Religion</label>
                            <input id="signup-religion" type="text" class="w-full px-4 py-2 mt-1 border rounded-lg">
                        </div>
                    </div>
                    <div>
                        <label class="text-sm font-medium text-gray-700">Email Address</label>
                        <input id="signup-email" type="email" required class="w-full px-4 py-2 mt-1 border rounded-lg">
                    </div>
                    <div>
                        <label class="text-sm font-medium text-gray-700">Password (min. 6 characters)</label>
                        <input id="signup-password" type="password" required class="w-full px-4 py-2 mt-1 border rounded-lg">
                    </div>
                    <button type="submit" class="w-full py-3 px-4 text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 font-semibold">Sign Up</button>
                </form>
                <div id="signup-error" class="text-red-500 text-sm text-center"></div>
                <p class="text-sm text-center text-gray-600">
                    Already have an account? <a href="#" id="show-login" class="font-medium text-indigo-600 hover:underline">Log in</a>
                </p>
            </div>
        </div>
        
        <!-- Pending Approval Screen -->
        <div id="pending-approval-screen" class="hidden min-h-screen flex items-center justify-center bg-gray-100">
            <div class="w-full max-w-md p-8 text-center bg-white rounded-xl shadow-lg">
                <i class="fas fa-hourglass-half text-5xl text-amber-500 mx-auto"></i>
                <h1 class="text-2xl font-bold text-gray-800 mt-4">Application Submitted!</h1>
                <p class="text-gray-600 mt-2">Your account is pending approval from an administrator. You will be notified once your account is approved. Please check back later.</p>
                <button id="logout-pending" class="mt-6 w-full py-2 px-4 text-white bg-red-500 rounded-lg hover:bg-red-600 font-semibold">Log Out</button>
            </div>
        </div>

        <!-- Main Application UI -->
        <div id="main-app" class="hidden">
            <!-- Header -->
            <header class="bg-white shadow-md sticky top-0 z-40">
                <div class="container mx-auto px-4">
                    <div class="flex justify-between items-center py-3">
                        <div class="text-2xl font-bold text-indigo-600">
                            <a href="#" class="nav-link" data-page="feed">CampusConnect</a>
                        </div>
                        <div class="flex items-center space-x-6">
                            <a href="#" class="nav-link text-gray-600 hover:text-indigo-600" data-page="feed"><i class="fas fa-home text-xl"></i></a>
                            <a href="#" class="nav-link text-gray-600 hover:text-indigo-600" data-page="messenger"><i class="fas fa-comments text-xl"></i></a>
                            <a href="#" class="nav-link text-gray-600 hover:text-indigo-600" data-page="notice-board"><i class="fas fa-bullhorn text-xl"></i></a>
                            <a href="#" id="admin-panel-button" class="hidden nav-link text-gray-600 hover:text-indigo-600" data-page="admin-panel"><i class="fas fa-user-shield text-xl"></i></a>
                        </div>
                        <div class="flex items-center space-x-4">
                            <div id="current-user-profile" class="flex items-center space-x-2 cursor-pointer">
                                <img id="header-user-img" src="https://placehold.co/40x40/E2E8F0/4A5568?text=U" class="w-8 h-8 rounded-full object-cover">
                                <span id="header-user-name" class="font-semibold text-gray-700 text-sm">User</span>
                            </div>
                            <button id="logout-main" class="text-gray-500 hover:text-red-600"><i class="fas fa-sign-out-alt text-xl"></i></button>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Main Content Area -->
            <main class="container mx-auto p-4 grid grid-cols-12 gap-6">
                
                <!-- Left Sidebar (Profile Info) -->
                <aside class="col-span-12 md:col-span-3">
                    <div class="bg-white p-4 rounded-lg shadow">
                         <div class="text-center">
                            <img id="sidebar-user-img" src="https://placehold.co/100x100/E2E8F0/4A5568?text=U" class="w-24 h-24 rounded-full object-cover mx-auto border-4 border-indigo-200">
                            <h2 id="sidebar-user-name" class="text-xl font-bold mt-2">User Name</h2>
                            <p id="sidebar-user-dept" class="text-sm text-gray-500">Department</p>
                        </div>
                        <hr class="my-4">
                        <div>
                            <h3 class="font-semibold text-gray-700">Profile Details</h3>
                            <ul class="mt-2 space-y-2 text-sm text-gray-600">
                                <li><i class="fas fa-id-card w-5"></i> Roll: <span id="sidebar-user-roll"></span></li>
                                <li><i class="fas fa-chalkboard-teacher w-5"></i> Class: <span id="sidebar-user-class"></span></li>
                                <li><i class="fas fa-venus-mars w-5"></i> Gender: <span id="sidebar-user-gender"></span></li>
                                <li><i class="fas fa-praying-hands w-5"></i> Religion: <span id="sidebar-user-religion"></span></li>
                            </ul>
                        </div>
                    </div>
                </aside>

                <!-- Center Content (Dynamic) -->
                <div id="page-content" class="col-span-12 md:col-span-6">
                    
                    <!-- Feed Page -->
                    <div id="feed-page" class="page">
                        <!-- Create Post -->
                        <div class="bg-white p-4 rounded-lg shadow mb-6">
                            <form id="create-post-form">
                                <textarea id="post-content" class="w-full p-2 border rounded-lg" placeholder="What's on your mind?"></textarea>
                                <div class="flex justify-between items-center mt-2">
                                    <div>
                                        <label for="post-image" class="cursor-pointer text-indigo-600 hover:text-indigo-800">
                                            <i class="fas fa-image"></i> Add Image
                                        </label>
                                        <input type="file" id="post-image" class="hidden" accept="image/*">
                                        <span id="image-name" class="text-sm text-gray-500 ml-2"></span>
                                    </div>
                                    <button type="submit" class="bg-indigo-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-indigo-700">Post</button>
                                </div>
                            </form>
                        </div>
                        <!-- Posts Feed -->
                        <div id="posts-feed-container" class="space-y-6">
                            <!-- Posts will be dynamically inserted here -->
                        </div>
                    </div>

                    <!-- Messenger Page -->
                    <div id="messenger-page" class="page hidden">
                        <div class="bg-white rounded-lg shadow h-[75vh] flex">
                            <!-- User List -->
                            <div class="w-1/3 border-r custom-scrollbar overflow-y-auto">
                                <div class="p-4 border-b">
                                    <h2 class="text-xl font-bold">Chats</h2>
                                    <input id="user-search-input" type="text" placeholder="Search for users..." class="w-full mt-2 p-2 border rounded-lg text-sm">
                                </div>
                                <div id="user-search-results" class="hidden bg-white border-b"></div>
                                <div id="chat-list-container">
                                    <!-- Chat list items will be here -->
                                </div>
                            </div>
                            <!-- Chat Window -->
                            <div id="chat-window" class="w-2/3 flex flex-col">
                                <div id="chat-placeholder" class="flex-grow flex items-center justify-center text-gray-500">
                                    Select a chat to start messaging
                                </div>
                                <div id="chat-area" class="hidden flex-grow flex flex-col">
                                    <div class="p-4 border-b flex items-center space-x-3">
                                        <img id="chat-with-img" src="https://placehold.co/40x40" class="w-10 h-10 rounded-full object-cover">
                                        <h3 id="chat-with-name" class="font-bold"></h3>
                                    </div>
                                    <div id="messages-container" class="flex-grow p-4 overflow-y-auto custom-scrollbar space-y-4">
                                        <!-- Messages will be here -->
                                    </div>
                                    <div class="p-4 border-t">
                                        <form id="send-message-form" class="flex space-x-3">
                                            <input id="message-input" type="text" placeholder="Type a message..." class="flex-grow p-2 border rounded-lg" autocomplete="off">
                                            <button type="submit" class="bg-indigo-600 text-white px-5 py-2 rounded-lg"><i class="fas fa-paper-plane"></i></button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Notice Board Page -->
                    <div id="notice-board-page" class="page hidden">
                        <div class="bg-white p-4 rounded-lg shadow">
                            <h2 class="text-2xl font-bold text-indigo-700 border-b pb-2 mb-4">College Notice Board</h2>
                            <div id="notice-board-container" class="space-y-4">
                                <!-- Notices will be dynamically inserted here -->
                            </div>
                        </div>
                    </div>

                    <!-- Admin Panel Page -->
                    <div id="admin-panel-page" class="page hidden">
                         <div class="bg-white p-4 rounded-lg shadow">
                            <h2 class="text-2xl font-bold text-red-700 border-b pb-2 mb-4">Admin Panel</h2>
                            <h3 class="text-lg font-semibold mb-2">Pending User Approvals</h3>
                            <div id="pending-users-container" class="space-y-4">
                                <!-- Pending users will be here -->
                            </div>
                        </div>
                    </div>

                </div>

                <!-- Right Sidebar (Placeholder) -->
                <aside class="hidden md:block md:col-span-3">
                    <div class="bg-white p-4 rounded-lg shadow">
                        <h3 class="font-semibold text-gray-700">Suggestions</h3>
                        <p class="text-sm text-gray-500 mt-2">Feature coming soon!</p>
                    </div>
                </aside>

            </main>
        </div>
        
        <!-- Generic Modal -->
        <div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="modal-content bg-white p-6 rounded-lg shadow-xl max-w-sm text-center">
                <p id="modal-message"></p>
                <button id="modal-close" class="mt-4 bg-indigo-600 text-white px-4 py-2 rounded-lg">Close</button>
            </div>
        </div>

        <!-- Confirmation Modal -->
        <div id="confirm-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="modal-content bg-white p-6 rounded-lg shadow-xl max-w-sm text-center">
                <p id="confirm-modal-message" class="mb-4"></p>
                <div class="flex justify-center space-x-4">
                    <button id="confirm-modal-cancel" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg">Cancel</button>
                    <button id="confirm-modal-confirm" class="bg-red-600 text-white px-4 py-2 rounded-lg">Confirm</button>
                </div>
            </div>
        </div>

    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            signOut, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            getDoc, 
            addDoc, 
            collection, 
            query, 
            where, 
            onSnapshot,
            orderBy,
            updateDoc,
            deleteDoc,
            serverTimestamp,
            arrayUnion,
            getDocs
        } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";
        import { 
            getStorage, 
            ref, 
            uploadBytes, 
            getDownloadURL 
        } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-storage.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDZ2_WsSGU_xM3IUa2-rqKK1YppIXI-SoY",
            authDomain: "campusconnect-a8447.firebaseapp.com",
            projectId: "campusconnect-a8447",
            storageBucket: "campusconnect-a8447.appspot.com",
            messagingSenderId: "512467118728",
            appId: "1:512467118728:web:2c8cb155422e6e181d0d3d",
            measurementId: "G-62XR5TLSN7"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // --- GLOBAL STATE & CONSTANTS ---
        let currentUser = null;
        let currentUserProfile = null;
        const ADMIN_UID = "RP4zuS7heVaxRJXUfWQalPn9TBD3";
        let currentChatId = null;
        let activeListeners = [];
        let confirmCallback = null;

        // --- UI ELEMENT REFERENCES ---
        const loadingScreen = document.getElementById('loading-screen');
        const loginScreen = document.getElementById('login-screen');
        const signupScreen = document.getElementById('signup-screen');
        const pendingScreen = document.getElementById('pending-approval-screen');
        const mainApp = document.getElementById('main-app');
        const pages = document.querySelectorAll('.page');
        const pageContent = document.getElementById('page-content');
        const navLinks = document.querySelectorAll('.nav-link');
        const loginButton = document.getElementById('login-button');
        const loginButtonText = loginButton.querySelector('.btn-text');
        const loginButtonLoader = loginButton.querySelector('.btn-loader');

        // --- UTILITY & HELPER FUNCTIONS ---

        const showScreen = (screenId) => {
            [loadingScreen, loginScreen, signupScreen, pendingScreen, mainApp].forEach(screen => {
                screen.classList.add('hidden');
            });
            document.getElementById(screenId).classList.remove('hidden');
        };

        const showPage = (pageId) => {
            pages.forEach(page => page.classList.add('hidden'));
            document.getElementById(`${pageId}-page`).classList.remove('hidden');
        };
        
        const showModal = (message) => {
            document.getElementById('modal-message').textContent = message;
            document.getElementById('modal').classList.remove('hidden');
        };
        
        const showConfirmModal = (message, onConfirm) => {
            document.getElementById('confirm-modal-message').textContent = message;
            document.getElementById('confirm-modal').classList.remove('hidden');
            confirmCallback = onConfirm;
        };

        const formatTimestamp = (timestamp) => {
            if (!timestamp) return 'Just now';
            const date = timestamp.toDate();
            return date.toLocaleString('en-US', {
                year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
            });
        };

        const detachAllListeners = () => {
            activeListeners.forEach(unsubscribe => unsubscribe());
            activeListeners = [];
        };
        
        // --- AUTHENTICATION LOGIC ---

        onAuthStateChanged(auth, async (user) => {
            detachAllListeners();
            loadingScreen.classList.remove('hidden');

            if (user) {
                currentUser = user;
                try {
                    const userDocRef = doc(db, "users", user.uid);
                    const userDoc = await getDoc(userDocRef);

                    if (userDoc.exists()) {
                        currentUserProfile = { id: userDoc.id, ...userDoc.data() };
                        
                        // *** FIX: Self-healing for admin user ***
                        // If the admin logs in and their status isn't approved, fix it.
                        if (currentUserProfile.id === ADMIN_UID && currentUserProfile.status !== 'approved') {
                            await updateDoc(userDocRef, { status: 'approved' });
                            currentUserProfile.status = 'approved'; // Update local profile immediately
                            console.log("Admin status automatically corrected to 'approved'.");
                        }
                        
                        // Route user based on their status
                        if (currentUserProfile.status === 'approved') {
                            await initializeMainApp();
                            showScreen('main-app');
                        } else if (currentUserProfile.status === 'pending') {
                            showScreen('pending-approval-screen');
                        } else if (currentUserProfile.status === 'rejected') {
                            await signOut(auth);
                            showModal("Your account application has been rejected. Please contact an administrator.");
                        } else {
                            // This case is now less likely for the admin, but remains as a fallback.
                            await signOut(auth);
                            showModal("Your account has an unknown status. Please contact support.");
                        }
                    } else {
                        await signOut(auth);
                        showModal("Your user profile was not found. Please sign up again.");
                    }
                } catch (error) {
                    console.error("Error fetching user profile:", error);
                    await signOut(auth);
                    showModal("An error occurred while loading your profile. Please try again.");
                }
            } else {
                currentUser = null;
                currentUserProfile = null;
                showScreen('login-screen');
            }

            loadingScreen.classList.add('hidden');
            loginButton.disabled = false;
            loginButtonText.classList.remove('hidden');
            loginButtonLoader.classList.add('hidden');
        });

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const errorDiv = document.getElementById('login-error');
            errorDiv.textContent = '';

            loginButton.disabled = true;
            loginButtonText.classList.add('hidden');
            loginButtonLoader.classList.remove('hidden');
            
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                errorDiv.textContent = "Invalid email or password.";
                loginButton.disabled = false;
                loginButtonText.classList.remove('hidden');
                loginButtonLoader.classList.add('hidden');
            }
        });

        document.getElementById('signup-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            const errorDiv = document.getElementById('signup-error');
            errorDiv.textContent = '';

            const userData = {
                name: document.getElementById('signup-name').value,
                roll: document.getElementById('signup-roll').value,
                department: document.getElementById('signup-department').value,
                class: document.getElementById('signup-class').value,
                gender: document.getElementById('signup-gender').value,
                religion: document.getElementById('signup-religion').value,
                email: email,
                profilePicUrl: '',
                status: 'pending',
                createdAt: serverTimestamp()
            };

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                await setDoc(doc(db, "users", userCredential.user.uid), userData);
            } catch (error) {
                errorDiv.textContent = error.message;
            }
        });

        const handleLogout = async () => {
            await signOut(auth);
        };

        document.getElementById('logout-main').addEventListener('click', handleLogout);
        document.getElementById('logout-pending').addEventListener('click', handleLogout);
        
        document.getElementById('show-signup').addEventListener('click', (e) => { e.preventDefault(); showScreen('signup-screen'); });
        document.getElementById('show-login').addEventListener('click', (e) => { e.preventDefault(); showScreen('login-screen'); });
        
        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                showPage(link.dataset.page);
            });
        });

        // --- MAIN APP INITIALIZATION ---
        async function initializeMainApp() {
            // Populate user info in UI
            document.getElementById('header-user-name').textContent = currentUserProfile.name.split(' ')[0];
            document.getElementById('header-user-img').src = currentUserProfile.profilePicUrl || `https://placehold.co/40x40/E2E8F0/4A5568?text=${currentUserProfile.name.charAt(0)}`;
            
            document.getElementById('sidebar-user-name').textContent = currentUserProfile.name;
            document.getElementById('sidebar-user-dept').textContent = currentUserProfile.department;
            document.getElementById('sidebar-user-img').src = currentUserProfile.profilePicUrl || `https://placehold.co/100x100/E2E8F0/4A5568?text=${currentUserProfile.name.charAt(0)}`;
            document.getElementById('sidebar-user-roll').textContent = currentUserProfile.roll;
            document.getElementById('sidebar-user-class').textContent = currentUserProfile.class;
            document.getElementById('sidebar-user-gender').textContent = currentUserProfile.gender;
            document.getElementById('sidebar-user-religion').textContent = currentUserProfile.religion;

            document.getElementById('admin-panel-button').classList.toggle('hidden', currentUser.uid !== ADMIN_UID);
            
            // Load initial content and attach listeners
            showPage('feed');
            initializeFeed();
            initializeMessenger();
            initializeNoticeBoard();
            if (currentUser.uid === ADMIN_UID) {
                initializeAdminPanel();
            }
        }

        // --- FEED LOGIC ---
        function initializeFeed() {
            const createPostForm = document.getElementById('create-post-form');
            const postImageInput = document.getElementById('post-image');
            const imageNameSpan = document.getElementById('image-name');

            postImageInput.addEventListener('change', () => {
                imageNameSpan.textContent = postImageInput.files.length > 0 ? postImageInput.files[0].name : '';
            });

            createPostForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const content = document.getElementById('post-content').value.trim();
                const imageFile = postImageInput.files[0];

                if (!content && !imageFile) {
                    showModal("Please write something or add an image to post.");
                    return;
                }
                
                let imageUrl = '';
                if (imageFile) {
                    const storageRef = ref(storage, `posts/${currentUser.uid}/${Date.now()}_${imageFile.name}`);
                    await uploadBytes(storageRef, imageFile);
                    imageUrl = await getDownloadURL(storageRef);
                }

                await addDoc(collection(db, "posts"), {
                    authorId: currentUser.uid,
                    authorName: currentUserProfile.name,
                    authorProfilePic: currentUserProfile.profilePicUrl || '',
                    content: content,
                    imageUrl: imageUrl,
                    likes: [],
                    createdAt: serverTimestamp()
                });

                createPostForm.reset();
                imageNameSpan.textContent = '';
            });

            const postsQuery = query(collection(db, "posts"), orderBy("createdAt", "desc"));
            const unsubscribePosts = onSnapshot(postsQuery, (snapshot) => {
                const feedContainer = document.getElementById('posts-feed-container');
                feedContainer.innerHTML = '';
                if (snapshot.empty) {
                    feedContainer.innerHTML = `<div class="text-center text-gray-500 p-4 bg-white rounded-lg shadow">No posts yet. Be the first to share!</div>`;
                } else {
                    snapshot.docs.forEach(doc => renderPost(doc.id, doc.data()));
                }
            });
            activeListeners.push(unsubscribePosts);
        }

        function renderPost(postId, postData) {
            const feedContainer = document.getElementById('posts-feed-container');
            const postElement = document.createElement('div');
            postElement.className = 'bg-white p-4 rounded-lg shadow';
            postElement.dataset.postId = postId;

            const hasLiked = postData.likes && postData.likes.includes(currentUser.uid);

            postElement.innerHTML = `
                <div class="flex items-center mb-3">
                    <img src="${postData.authorProfilePic || `https://placehold.co/40x40/E2E8F0/4A5568?text=${postData.authorName.charAt(0)}`}" class="w-10 h-10 rounded-full mr-3 object-cover">
                    <div>
                        <p class="font-bold">${postData.authorName}</p>
                        <p class="text-xs text-gray-500">${formatTimestamp(postData.createdAt)}</p>
                    </div>
                    ${(postData.authorId === currentUser.uid || currentUser.uid === ADMIN_UID) ? 
                        `<button class="delete-post-btn ml-auto text-gray-400 hover:text-red-500" data-post-id="${postId}"><i class="fas fa-trash"></i></button>` : ''}
                </div>
                <p class="mb-3 text-gray-800 whitespace-pre-wrap">${postData.content}</p>
                ${postData.imageUrl ? `<img src="${postData.imageUrl}" class="rounded-lg w-full max-h-96 object-cover mb-3">` : ''}
                <div class="flex items-center justify-between text-gray-500 border-t pt-2">
                    <button class="like-btn flex items-center space-x-2 hover:text-indigo-600 ${hasLiked ? 'text-indigo-600 font-bold' : ''}" data-post-id="${postId}">
                        <i class="fas fa-thumbs-up"></i>
                        <span>${postData.likes ? postData.likes.length : 0} Likes</span>
                    </button>
                    <button class="comment-btn flex items-center space-x-2 hover:text-indigo-600" data-post-id="${postId}">
                        <i class="fas fa-comment"></i>
                        <span id="comment-count-${postId}">Comments</span>
                    </button>
                </div>
                <div id="comments-section-${postId}" class="mt-4 border-t pt-4 hidden">
                    <form class="comment-form flex space-x-2 mb-4" data-post-id="${postId}">
                        <input type="text" class="comment-input w-full p-2 border rounded-lg" placeholder="Write a comment...">
                        <button type="submit" class="bg-indigo-500 text-white px-4 rounded-lg">Post</button>
                    </form>
                    <div id="comments-list-${postId}" class="space-y-3"></div>
                </div>
            `;
            feedContainer.appendChild(postElement);

            const commentsQuery = query(collection(db, `posts/${postId}/comments`), orderBy("createdAt", "asc"));
            const unsubscribeComments = onSnapshot(commentsQuery, (snapshot) => {
                const commentsList = document.getElementById(`comments-list-${postId}`);
                const commentCount = document.getElementById(`comment-count-${postId}`);
                if (!commentsList || !commentCount) return;
                
                commentsList.innerHTML = '';
                snapshot.forEach(doc => {
                    const commentData = doc.data();
                    const commentDiv = document.createElement('div');
                    commentDiv.className = 'flex items-start space-x-2 text-sm';
                    commentDiv.innerHTML = `
                        <img src="${commentData.authorProfilePic || `https://placehold.co/32x32/E2E8F0/4A5568?text=${commentData.authorName.charAt(0)}`}" class="w-8 h-8 rounded-full object-cover">
                        <div class="bg-gray-100 p-2 rounded-lg">
                            <p class="font-bold">${commentData.authorName}</p>
                            <p>${commentData.content}</p>
                        </div>
                    `;
                    commentsList.appendChild(commentDiv);
                });
                commentCount.textContent = `${snapshot.size} Comments`;
            });
            activeListeners.push(unsubscribeComments);
        }

        pageContent.addEventListener('click', async (e) => {
            const likeBtn = e.target.closest('.like-btn');
            const commentBtn = e.target.closest('.comment-btn');
            const deleteBtn = e.target.closest('.delete-post-btn');

            if (likeBtn) {
                const postId = likeBtn.dataset.postId;
                const postRef = doc(db, "posts", postId);
                const postDoc = await getDoc(postRef);
                const postLikes = postDoc.data().likes || [];
                
                if (postLikes.includes(currentUser.uid)) {
                    await updateDoc(postRef, { likes: postLikes.filter(uid => uid !== currentUser.uid) });
                } else {
                    await updateDoc(postRef, { likes: arrayUnion(currentUser.uid) });
                }
            }

            if (commentBtn) {
                const postId = commentBtn.dataset.postId;
                document.getElementById(`comments-section-${postId}`).classList.toggle('hidden');
            }
            
            if (deleteBtn) {
                const postId = deleteBtn.dataset.postId;
                showConfirmModal("Are you sure you want to delete this post?", async () => {
                    await deleteDoc(doc(db, "posts", postId));
                    showModal("Post deleted successfully.");
                });
            }
        });
        
        pageContent.addEventListener('submit', async (e) => {
            if (e.target.classList.contains('comment-form')) {
                e.preventDefault();
                const postId = e.target.dataset.postId;
                const input = e.target.querySelector('.comment-input');
                const content = input.value.trim();
                if (content) {
                    await addDoc(collection(db, `posts/${postId}/comments`), {
                        authorId: currentUser.uid,
                        authorName: currentUserProfile.name,
                        authorProfilePic: currentUserProfile.profilePicUrl || '',
                        content: content,
                        createdAt: serverTimestamp()
                    });
                    input.value = '';
                }
            }
        });

        // --- MESSENGER LOGIC ---
        function initializeMessenger() {
            const searchInput = document.getElementById('user-search-input');
            const searchResultsContainer = document.getElementById('user-search-results');
            
            let searchTimeout;
            searchInput.addEventListener('keyup', () => {
                clearTimeout(searchTimeout);
                const searchTerm = searchInput.value.trim().toLowerCase();
                if (searchTerm.length < 2) {
                    searchResultsContainer.classList.add('hidden');
                    return;
                }
                searchTimeout = setTimeout(async () => {
                    const usersRef = collection(db, "users");
                    const q = query(usersRef, where("status", "==", "approved"));
                    const querySnapshot = await getDocs(q);
                    
                    searchResultsContainer.innerHTML = '';
                    let found = false;
                    querySnapshot.forEach(doc => {
                        const user = { id: doc.id, ...doc.data() };
                        if (user.id !== currentUser.uid && user.name.toLowerCase().includes(searchTerm)) {
                            found = true;
                            const userDiv = document.createElement('div');
                            userDiv.className = 'p-3 hover:bg-gray-100 cursor-pointer flex items-center space-x-3';
                            userDiv.addEventListener('click', () => startChatWith(user));
                            userDiv.innerHTML = `
                                <img src="${user.profilePicUrl || `https://placehold.co/40x40/E2E8F0/4A5568?text=${user.name.charAt(0)}`}" class="w-10 h-10 rounded-full object-cover">
                                <span>${user.name}</span>
                            `;
                            searchResultsContainer.appendChild(userDiv);
                        }
                    });
                    searchResultsContainer.classList.toggle('hidden', !found);
                }, 300);
            });

            // Real-time listener for the user's chats
            const chatsQuery = query(collection(db, "chats"), where("participants", "array-contains", currentUser.uid));
            const unsubscribeChats = onSnapshot(chatsQuery, (snapshot) => {
                const chatListContainer = document.getElementById('chat-list-container');
                chatListContainer.innerHTML = '';
                if (snapshot.empty) {
                    chatListContainer.innerHTML = `<p class="p-4 text-sm text-gray-500">No active chats. Search for a user to start a conversation.</p>`;
                    return;
                }

                const sortedDocs = snapshot.docs.sort((a, b) => (b.data().lastMessageTimestamp?.toMillis() || 0) - (a.data().lastMessageTimestamp?.toMillis() || 0));
                sortedDocs.forEach(doc => renderChatListItem(doc.id, doc.data()));
            });
            activeListeners.push(unsubscribeChats);
        }

        function renderChatListItem(chatId, chatData) {
            const chatListContainer = document.getElementById('chat-list-container');
            const otherParticipantId = chatData.participants.find(p => p !== currentUser.uid);
            if (!otherParticipantId || !chatData.participantDetails) return;
            
            const otherUserDetails = chatData.participantDetails[otherParticipantId];
            if (!otherUserDetails) return;

            const chatItem = document.createElement('div');
            chatItem.className = 'p-3 hover:bg-gray-100 cursor-pointer flex items-center space-x-3 border-b';
            chatItem.dataset.chatId = chatId;
            chatItem.dataset.otherUserId = otherParticipantId;
            chatItem.dataset.otherUserName = otherUserDetails.name;
            chatItem.dataset.otherUserPic = otherUserDetails.profilePicUrl || '';

            chatItem.innerHTML = `
                <img src="${otherUserDetails.profilePicUrl || `https://placehold.co/40x40/E2E8F0/4A5568?text=${otherUserDetails.name.charAt(0)}`}" class="w-12 h-12 rounded-full object-cover">
                <div>
                    <p class="font-bold">${otherUserDetails.name}</p>
                    <p class="text-sm text-gray-500 truncate">${chatData.lastMessage || 'No messages yet'}</p>
                </div>
            `;
            chatListContainer.appendChild(chatItem);
        }

        document.getElementById('chat-list-container').addEventListener('click', (e) => {
            const chatItem = e.target.closest('[data-chat-id]');
            if (chatItem) {
                const otherUser = {
                    id: chatItem.dataset.otherUserId,
                    name: chatItem.dataset.otherUserName,
                    profilePicUrl: chatItem.dataset.otherUserPic
                };
                openChatWindow(chatItem.dataset.chatId, otherUser);
            }
        });

        async function startChatWith(otherUser) {
            document.getElementById('user-search-input').value = '';
            document.getElementById('user-search-results').classList.add('hidden');
            
            const chatId = currentUser.uid < otherUser.id ? `${currentUser.uid}_${otherUser.id}` : `${otherUser.id}_${currentUser.uid}`;
            const chatRef = doc(db, "chats", chatId);
            const chatDoc = await getDoc(chatRef);

            if (!chatDoc.exists()) {
                await setDoc(chatRef, {
                    participants: [currentUser.uid, otherUser.id],
                    lastMessage: '',
                    lastMessageTimestamp: serverTimestamp(),
                    participantDetails: {
                        [currentUser.uid]: { name: currentUserProfile.name, profilePicUrl: currentUserProfile.profilePicUrl },
                        [otherUser.id]: { name: otherUser.name, profilePicUrl: otherUser.profilePicUrl }
                    }
                });
            }
            openChatWindow(chatId, otherUser);
        }
        
        function openChatWindow(chatId, otherUser) {
            currentChatId = chatId;
            document.getElementById('chat-placeholder').classList.add('hidden');
            document.getElementById('chat-area').classList.remove('hidden');
            
            document.getElementById('chat-with-name').textContent = otherUser.name;
            document.getElementById('chat-with-img').src = otherUser.profilePicUrl || `https://placehold.co/40x40/E2E8F0/4A5568?text=${otherUser.name.charAt(0)}`;
            
            const messagesContainer = document.getElementById('messages-container');
            const messagesQuery = query(collection(db, `chats/${chatId}/messages`), orderBy("createdAt", "asc"));
            
            const unsubscribe = onSnapshot(messagesQuery, (snapshot) => {
                messagesContainer.innerHTML = '';
                snapshot.forEach(doc => {
                    const msg = doc.data();
                    const msgDiv = document.createElement('div');
                    const isSender = msg.senderId === currentUser.uid;
                    msgDiv.className = `flex items-end gap-2 ${isSender ? 'justify-end' : 'justify-start'}`;
                    msgDiv.innerHTML = `
                        <div class="max-w-xs md:max-w-md p-3 rounded-2xl ${isSender ? 'bg-indigo-500 text-white' : 'bg-gray-200 text-gray-800'}">
                            <p>${msg.text}</p>
                        </div>
                    `;
                    messagesContainer.appendChild(msgDiv);
                });
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            });
            activeListeners.push(unsubscribe);
        }

        document.getElementById('send-message-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const input = document.getElementById('message-input');
            const text = input.value.trim();
            if (text && currentChatId) {
                const tempInputVal = input.value;
                input.value = '';

                await addDoc(collection(db, `chats/${currentChatId}/messages`), {
                    text: text,
                    senderId: currentUser.uid,
                    createdAt: serverTimestamp()
                });
                await updateDoc(doc(db, "chats", currentChatId), {
                    lastMessage: text,
                    lastMessageTimestamp: serverTimestamp()
                });
            }
        });

        // --- NOTICE BOARD LOGIC ---
        function initializeNoticeBoard() {
            const noticesQuery = query(collection(db, "notices"), orderBy("createdAt", "desc"));
            const unsubscribe = onSnapshot(noticesQuery, (snapshot) => {
                const container = document.getElementById('notice-board-container');
                container.innerHTML = '';
                if(snapshot.empty) {
                    container.innerHTML = `<p class="text-gray-500">No notices at the moment.</p>`;
                    return;
                }
                snapshot.forEach(doc => {
                    const notice = doc.data();
                    const noticeDiv = document.createElement('div');
                    noticeDiv.className = 'border-l-4 border-indigo-500 p-4 bg-indigo-50 rounded-r-lg';
                    noticeDiv.innerHTML = `
                        <h4 class="font-bold text-lg text-indigo-800">${notice.title}</h4>
                        <p class="text-gray-700 mt-1 whitespace-pre-wrap">${notice.content}</p>
                        <p class="text-xs text-gray-500 mt-2">Posted on: ${formatTimestamp(notice.createdAt)}</p>
                    `;
                    container.appendChild(noticeDiv);
                });
            });
            activeListeners.push(unsubscribe);
        }

        // --- ADMIN PANEL LOGIC ---
        function initializeAdminPanel() {
            const pendingUsersQuery = query(collection(db, "users"), where("status", "==", "pending"));
            const unsubscribe = onSnapshot(pendingUsersQuery, (snapshot) => {
                const container = document.getElementById('pending-users-container');
                container.innerHTML = '';
                if (snapshot.empty) {
                    container.innerHTML = '<p class="text-gray-500">No pending approvals.</p>';
                    return;
                }
                snapshot.forEach(doc => {
                    const user = { id: doc.id, ...doc.data() };
                    const userDiv = document.createElement('div');
                    userDiv.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg border';
                    userDiv.innerHTML = `
                        <div>
                            <p class="font-bold">${user.name} <span class="font-normal text-gray-600">(${user.email})</span></p>
                            <p class="text-sm text-gray-500">Roll: ${user.roll} | Dept: ${user.department}</p>
                        </div>
                        <div class="flex space-x-2">
                            <button class="approve-btn bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600" data-uid="${user.id}">Approve</button>
                            <button class="reject-btn bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600" data-uid="${user.id}">Reject</button>
                        </div>
                    `;
                    container.appendChild(userDiv);
                });
            });
            activeListeners.push(unsubscribe);
        }

        document.getElementById('admin-panel-page').addEventListener('click', async (e) => {
            const approveBtn = e.target.closest('.approve-btn');
            const rejectBtn = e.target.closest('.reject-btn');

            if (approveBtn) {
                await updateDoc(doc(db, "users", approveBtn.dataset.uid), { status: 'approved' });
                showModal('User approved successfully.');
            }

            if (rejectBtn) {
                await updateDoc(doc(db, "users", rejectBtn.dataset.uid), { status: 'rejected' });
                showModal('User rejected successfully.');
            }
        });
        
        // --- MODAL & CONFIRMATION LOGIC ---
        document.getElementById('modal-close').addEventListener('click', () => {
             document.getElementById('modal').classList.add('hidden');
        });

        document.getElementById('confirm-modal-cancel').addEventListener('click', () => {
             document.getElementById('confirm-modal').classList.add('hidden');
             confirmCallback = null;
        });

        document.getElementById('confirm-modal-confirm').addEventListener('click', () => {
            if (typeof confirmCallback === 'function') {
                confirmCallback();
            }
            document.getElementById('confirm-modal').classList.add('hidden');
            confirmCallback = null;
        });

    </script>
</body>
</html>

