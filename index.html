<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CampusConnect by Infinity Group</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar for a better look */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #2d3748;
        }
        ::-webkit-scrollbar-thumb {
            background: #4a5568;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #718096;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-200 transition-colors duration-300">

    <!-- Main Application Container -->
    <div id="app-container">

        <!-- Loading Spinner -->
        <div id="loading-spinner" class="fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center z-50">
            <div class="animate-spin rounded-full h-32 w-32 border-t-4 border-b-4 border-blue-500"></div>
        </div>

        <!-- Login and Signup Page -->
        <div id="auth-page" class="hidden">
            <div class="min-h-screen flex items-center justify-center bg-gray-50 dark:bg-gray-800">
                <div class="max-w-md w-full p-8 bg-white dark:bg-gray-900 rounded-2xl shadow-lg space-y-6">
                    <!-- Login Form -->
                    <div id="login-form-container">
                        <h2 class="text-3xl font-bold text-center text-gray-900 dark:text-white">Welcome to CampusConnect</h2>
                        <p class="text-center text-gray-500 dark:text-gray-400">Sign in to continue</p>
                        <form id="login-form" class="mt-8 space-y-6">
                            <input type="email" id="login-email" placeholder="Email Address" required class="w-full px-4 py-3 bg-gray-100 dark:bg-gray-800 border-transparent rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <input type="password" id="login-password" placeholder="Password" required class="w-full px-4 py-3 bg-gray-100 dark:bg-gray-800 border-transparent rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <button type="submit" class="w-full py-3 px-4 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-transform transform hover:scale-105">Login</button>
                        </form>
                        <p class="mt-4 text-center">Don't have an account? <a href="#" id="show-signup" class="font-medium text-blue-500 hover:text-blue-400">Sign up</a></p>
                    </div>
                    <!-- Signup Form -->
                    <div id="signup-form-container" class="hidden">
                        <h2 class="text-3xl font-bold text-center text-gray-900 dark:text-white">Create Account</h2>
                        <p class="text-center text-gray-500 dark:text-gray-400">Join the community</p>
                        <form id="signup-form" class="mt-8 space-y-4">
                            <input type="text" id="signup-name" placeholder="Full Name" required class="w-full px-4 py-2 bg-gray-100 dark:bg-gray-800 border-transparent rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <input type="email" id="signup-email" placeholder="Email Address" required class="w-full px-4 py-2 bg-gray-100 dark:bg-gray-800 border-transparent rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <input type="password" id="signup-password" placeholder="Password (min. 6 characters)" required class="w-full px-4 py-2 bg-gray-100 dark:bg-gray-800 border-transparent rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <input type="text" id="signup-roll" placeholder="Roll Number / Student ID" required class="w-full px-4 py-2 bg-gray-100 dark:bg-gray-800 border-transparent rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <input type="text" id="signup-department" placeholder="Department" required class="w-full px-4 py-2 bg-gray-100 dark:bg-gray-800 border-transparent rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <input type="text" id="signup-class" placeholder="Class / Year" required class="w-full px-4 py-2 bg-gray-100 dark:bg-gray-800 border-transparent rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <select id="signup-gender" required class="w-full px-4 py-2 bg-gray-100 dark:bg-gray-800 border-transparent rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="" disabled selected>Select Gender</option>
                                <option value="male">Male</option>
                                <option value="female">Female</option>
                                <option value="other">Other</option>
                            </select>
                            <input type="text" id="signup-religion" placeholder="Religion" required class="w-full px-4 py-2 bg-gray-100 dark:bg-gray-800 border-transparent rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <button type="submit" class="w-full py-3 px-4 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-transform transform hover:scale-105">Sign Up</button>
                        </form>
                        <p class="mt-4 text-center">Already have an account? <a href="#" id="show-login" class="font-medium text-blue-500 hover:text-blue-400">Login</a></p>
                    </div>
                     <p id="auth-error" class="text-red-500 text-center mt-2"></p>
                </div>
            </div>
        </div>

        <!-- Pending Approval Page -->
        <div id="pending-approval-page" class="hidden">
            <div class="min-h-screen flex flex-col items-center justify-center text-center p-4">
                <i class="fas fa-hourglass-half text-6xl text-yellow-500 mb-4"></i>
                <h1 class="text-4xl font-bold">Application Submitted!</h1>
                <p class="mt-2 text-lg text-gray-600 dark:text-gray-400">Your account is pending approval from an administrator.</p>
                <p class="mt-1 text-gray-500">You will be notified once your account is approved. Please check back later.</p>
                <button id="logout-btn-pending" class="mt-8 px-6 py-2 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-lg">Logout</button>
            </div>
        </div>

        <!-- Main Application (Feed, etc.) -->
        <div id="main-app" class="hidden">
            <!-- Header -->
            <header class="bg-white dark:bg-gray-800 shadow-md sticky top-0 z-40">
                <div class="container mx-auto px-4 py-3 flex justify-between items-center">
                    <h1 class="text-2xl font-bold text-blue-600 dark:text-blue-400">CampusConnect</h1>
                    <div class="flex items-center space-x-4">
                        <span id="user-greeting" class="font-semibold"></span>
                        <button id="admin-panel-btn" class="hidden px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg"><i class="fas fa-user-shield mr-2"></i>Admin Panel</button>
                        <button id="logout-btn-main" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg"><i class="fas fa-sign-out-alt mr-2"></i>Logout</button>
                    </div>
                </div>
            </header>

            <!-- Main Content -->
            <main class="container mx-auto p-4 grid grid-cols-1 md:grid-cols-4 gap-6">
                <!-- Left Sidebar (Profile, Nav) -->
                <aside class="md:col-span-1">
                    <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow">
                        <h3 class="font-bold text-lg mb-2">My Profile</h3>
                        <div id="profile-summary">
                            <!-- Profile info will be injected here -->
                        </div>
                    </div>
                     <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow mt-4">
                        <h3 class="font-bold text-lg mb-2">Navigation</h3>
                        <nav>
                            <ul>
                                <li><a href="#" class="block py-2 px-4 rounded hover:bg-gray-200 dark:hover:bg-gray-700"><i class="fas fa-home mr-2"></i>Home Feed</a></li>
                                <li><a href="#" class="block py-2 px-4 rounded hover:bg-gray-200 dark:hover:bg-gray-700"><i class="fas fa-envelope mr-2"></i>Messages</a></li>
                                <li><a href="#" class="block py-2 px-4 rounded hover:bg-gray-200 dark:hover:bg-gray-700"><i class="fas fa-bell mr-2"></i>Notice Board</a></li>
                            </ul>
                        </nav>
                    </div>
                </aside>

                <!-- Center (Feed) -->
                <div class="md:col-span-2">
                    <!-- Create Post -->
                    <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow mb-6">
                        <h3 class="font-bold text-lg mb-3">Create a Post</h3>
                        <form id="create-post-form">
                            <textarea id="post-content" class="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-lg border-transparent focus:ring-2 focus:ring-blue-500" rows="3" placeholder="What's on your mind?"></textarea>
                            <div class="flex justify-between items-center mt-3">
                                <input type="file" id="post-image-input" class="text-sm">
                                <button type="submit" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg">Post</button>
                            </div>
                        </form>
                    </div>

                    <!-- Posts Feed -->
                    <div id="posts-feed" class="space-y-6">
                        <!-- Posts will be injected here -->
                    </div>
                </div>

                <!-- Right Sidebar (Users/Chat) -->
                <aside class="md:col-span-1">
                    <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow">
                        <h3 class="font-bold text-lg mb-2">Online Users</h3>
                        <div id="online-users-list">
                            <!-- User list for chat will be injected here -->
                            <p class="text-sm text-gray-500">Messaging coming soon...</p>
                        </div>
                    </div>
                </aside>
            </main>
        </div>

        <!-- Admin Panel Modal -->
        <div id="admin-panel-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-11/12 max-w-4xl max-h-[90vh] flex flex-col">
                <div class="p-4 border-b dark:border-gray-700 flex justify-between items-center">
                    <h2 class="text-2xl font-bold">Admin Panel - Pending Approvals</h2>
                    <button id="close-admin-panel" class="text-gray-500 hover:text-gray-800 dark:hover:text-gray-200">&times;</button>
                </div>
                <div class="p-4 overflow-y-auto">
                    <div id="pending-users-container" class="space-y-4">
                        <!-- Pending user cards will be injected here -->
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            signOut, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            getDoc, 
            collection, 
            query, 
            where, 
            getDocs, 
            updateDoc,
            addDoc,
            serverTimestamp,
            onSnapshot,
            orderBy
        } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";
        import { 
            getStorage, 
            ref, 
            uploadBytes, 
            getDownloadURL 
        } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-storage.js";

        // Your web app's Firebase configuration
        // IMPORTANT: Replace this with your own Firebase project's configuration!
        const firebaseConfig = {
            apiKey: "AIzaSyDZ2_WsSGU_xM3IUa2-rqKK1YppIXI-SoY",
            authDomain: "campusconnect-a8447.firebaseapp.com",
            projectId: "campusconnect-a8447",
            storageBucket: "campusconnect-a8447.firebasestorage.app",
            messagingSenderId: "512467118728",
            appId: "1:512467118728:web:2c8cb155422e6e181d0d3d",
            measurementId: "G-62XR5TLSN7"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // DOM Elements
        const loadingSpinner = document.getElementById('loading-spinner');
        const authPage = document.getElementById('auth-page');
        const mainApp = document.getElementById('main-app');
        const pendingPage = document.getElementById('pending-approval-page');
        const adminPanelBtn = document.getElementById('admin-panel-btn');
        const adminPanelModal = document.getElementById('admin-panel-modal');
        
        let currentUserData = null;

        // --- AUTHENTICATION & STATE MANAGEMENT ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // User is signed in
                const userDocRef = doc(db, "users", user.uid);
                const userDocSnap = await getDoc(userDocRef);

                if (userDocSnap.exists()) {
                    currentUserData = { uid: user.uid, ...userDocSnap.data() };
                    
                    // Update UI based on user status and role
                    updateUIForUser(currentUserData);

                } else {
                    // This case might happen if user doc creation failed after signup
                    console.error("User document not found in Firestore!");
                    showPage('auth');
                }
            } else {
                // User is signed out
                currentUserData = null;
                showPage('auth');
            }
        });

        function showPage(page) {
            loadingSpinner.classList.add('hidden');
            authPage.classList.add('hidden');
            mainApp.classList.add('hidden');
            pendingPage.classList.add('hidden');
            adminPanelModal.classList.add('hidden');

            if (page === 'auth') authPage.classList.remove('hidden');
            else if (page === 'main') mainApp.classList.remove('hidden');
            else if (page === 'pending') pendingPage.classList.remove('hidden');
        }

        async function updateUIForUser(userData) {
            if (userData.status === 'pending') {
                showPage('pending');
            } else if (userData.status === 'approved') {
                showPage('main');
                document.getElementById('user-greeting').textContent = `Hello, ${userData.name.split(' ')[0]}`;
                await loadProfileSummary(userData);
                await fetchAndDisplayPosts();
                if (userData.role === 'admin') {
                    adminPanelBtn.classList.remove('hidden');
                }
            } else if (userData.status === 'rejected') {
                // Handle rejected case (e.g., show a message and log out)
                alert('Your account application has been rejected.');
                signOut(auth);
            }
        }
        
        // --- AUTH FORM TOGGLING ---
        document.getElementById('show-signup').addEventListener('click', (e) => {
            e.preventDefault();
            document.getElementById('login-form-container').classList.add('hidden');
            document.getElementById('signup-form-container').classList.remove('hidden');
        });

        document.getElementById('show-login').addEventListener('click', (e) => {
            e.preventDefault();
            document.getElementById('signup-form-container').classList.add('hidden');
            document.getElementById('login-form-container').classList.remove('hidden');
        });

        // --- AUTH EVENT HANDLERS ---
        const authError = document.getElementById('auth-error');

        document.getElementById('signup-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            authError.textContent = '';
            const name = document.getElementById('signup-name').value;
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            const roll = document.getElementById('signup-roll').value;
            const department = document.getElementById('signup-department').value;
            const userClass = document.getElementById('signup-class').value;
            const gender = document.getElementById('signup-gender').value;
            const religion = document.getElementById('signup-religion').value;

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                // Create user document in Firestore
                await setDoc(doc(db, "users", user.uid), {
                    name,
                    email,
                    roll,
                    department,
                    class: userClass,
                    gender,
                    religion,
                    status: 'pending', // <<< KEY: New users are pending
                    role: 'user', // Default role
                    createdAt: serverTimestamp()
                });
                // The onAuthStateChanged listener will handle the UI redirect
            } catch (error) {
                console.error("Signup Error:", error);
                authError.textContent = error.message;
            }
        });

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            authError.textContent = '';
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
    